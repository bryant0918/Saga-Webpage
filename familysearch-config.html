<!doctype html>
<html lang="en" data-bs-theme="dark">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Family Saga - FamilySearch Configuration</title>

        <!-- Bootstrap CSS -->
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />

        <!-- Font Awesome Icons -->
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        />

        <!-- Google Fonts - Scandinavian Typography -->
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,500;0,700;1,400&display=swap"
            rel="stylesheet"
        />

        <!-- Custom CSS -->
        <link rel="stylesheet" href="custom.css" />

        <meta
            name="description"
            content="Configure your FamilySearch family tree to create your luxury family chart."
        />
        <link rel="icon" type="image/png" href="assets/saga.png" />
    </head>
    <body>
        <!-- Navigation -->
        <nav
            class="navbar navbar-expand-lg navbar-dark shadow-sm"
            style="background-color: var(--primary-black)"
        >
            <div class="container">
                <a
                    class="navbar-brand fw-bold d-flex align-items-center"
                    href="index.html"
                    style="color: var(--gold-primary)"
                >
                    <img
                        src="assets/saga.png"
                        alt="Family Saga"
                        style="
                            height: 40px;
                            width: auto;
                            margin-right: 10px;
                            border-radius: 50%;
                        "
                    />
                    Family Saga
                </a>
                <div class="ms-auto">
                    <a href="index.html" class="btn btn-outline-light btn-sm">
                        <i class="fas fa-arrow-left me-2"></i>Back to Home
                    </a>
                </div>
            </div>
        </nav>

        <div class="container py-5">
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div
                        class="alert alert-success mb-4"
                        style="
                            background: linear-gradient(
                                135deg,
                                #ecfdf5 0%,
                                #f0fdf4 100%
                            );
                            border-color: var(--gold-primary);
                            color: #065f46;
                        "
                    >
                        <div class="text-center">
                            <div
                                class="d-flex align-items-center justify-content-center mb-3"
                            >
                                <img
                                    src="assets/fs_logo.png"
                                    alt="FamilySearch Logo"
                                    style="
                                        height: 50px;
                                        width: auto;
                                        margin-right: 15px;
                                        filter: saturate(150%) invert(1%)
                                            sepia(10%) brightness(100%)
                                            contrast(105%);
                                    "
                                />
                                <i
                                    class="fas fa-check-circle fa-3x"
                                    style="color: var(--gold-primary)"
                                ></i>
                            </div>
                            <h2 class="mb-3" style="color: var(--gold-primary)">
                                Successfully Connected to FamilySearch!
                            </h2>
                            <div id="currentPersonInfo" class="mb-3">
                                <p style="color: #047857">
                                    Loading your account information...
                                </p>
                            </div>
                            <p style="color: #047857; margin: 0">
                                You're now authenticated and ready to build your
                                custom family tree.
                            </p>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-body p-5">
                            <h2
                                class="text-center mb-4"
                                style="color: var(--gold-primary)"
                            >
                                Configure Your Family Tree
                            </h2>

                            <form id="familySearchForm">
                                <h3
                                    class="mb-4"
                                    style="
                                        color: var(--gold-primary);
                                        font-size: 1.3rem;
                                    "
                                >
                                    Your Contact Info
                                </h3>

                                <div class="mb-3">
                                    <label for="contactName" class="form-label">
                                        Your Name
                                        <span style="color: #dc3545">*</span>
                                    </label>
                                    <input
                                        type="text"
                                        class="form-control"
                                        id="contactName"
                                        name="contact_name"
                                        placeholder="Enter your full name"
                                        required
                                    />
                                </div>

                                <div class="mb-3">
                                    <label
                                        for="contactEmail"
                                        class="form-label"
                                    >
                                        Your Email
                                        <span style="color: #dc3545">*</span>
                                    </label>
                                    <input
                                        type="email"
                                        class="form-control"
                                        id="contactEmail"
                                        name="contact_email"
                                        placeholder="Enter your email address"
                                        required
                                    />
                                </div>

                                <div class="mb-4">
                                    <label
                                        for="contactPhone"
                                        class="form-label"
                                    >
                                        Your Phone Number
                                        <span style="color: #dc3545">*</span>
                                    </label>
                                    <input
                                        type="tel"
                                        class="form-control"
                                        id="contactPhone"
                                        name="contact_phone"
                                        placeholder="Enter your phone number"
                                        required
                                    />
                                </div>

                                <h3
                                    class="mb-4"
                                    style="
                                        color: var(--gold-primary);
                                        font-size: 1.3rem;
                                    "
                                >
                                    Tree Configuration
                                </h3>

                                <div class="mb-3">
                                    <label
                                        for="startingPerson"
                                        class="form-label"
                                    >
                                        Starting Person ID
                                        <span style="color: #dc3545">*</span>
                                    </label>
                                    <input
                                        type="text"
                                        class="form-control"
                                        id="startingPerson"
                                        name="starting_person"
                                        placeholder="Enter FamilySearch Person ID (e.g., KWQS-BYD)"
                                        required
                                    />
                                    <div class="form-text">
                                        Enter the FamilySearch Person ID to use
                                        as the root of your family tree. You can
                                        find this in the URL when viewing a
                                        person on FamilySearch.
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="familyName" class="form-label">
                                        Family Name
                                        <span style="color: #dc3545">*</span>
                                    </label>
                                    <input
                                        type="text"
                                        class="form-control"
                                        id="familyName"
                                        name="title"
                                        placeholder="Enter your family name"
                                        required
                                    />
                                </div>

                                <div class="mb-4">
                                    <label for="treeType" class="form-label"
                                        >Tree Type</label
                                    >
                                    <select
                                        class="form-select"
                                        id="treeType"
                                        name="tree_type"
                                    >
                                        <option value="ancestor" selected>
                                            Ancestor Tree
                                        </option>
                                        <option value="descendant">
                                            Descendant Tree
                                        </option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label for="generations" class="form-label"
                                        >Number of Generations</label
                                    >
                                    <select
                                        class="form-select"
                                        id="generations"
                                        name="generations"
                                    >
                                        <option value="5" selected>
                                            5 Generations
                                        </option>
                                        <option value="4">4 Generations</option>
                                        <!-- <option value="3">3 Generations</option> -->
                                    </select>
                                    <div class="form-text">
                                        Choose how many generations to include
                                        in your family tree
                                    </div>
                                </div>

                                <div class="mb-4">
                                    <label for="theme" class="form-label"
                                        >Design Theme</label
                                    >
                                    <div class="row" id="themeSelection">
                                        <div class="col-md-6 col-lg-3 mb-3">
                                            <div
                                                class="theme-selector"
                                                data-theme="royal-heritage"
                                                onclick="selectTheme('royal-heritage')"
                                            >
                                                <div class="text-center">
                                                    <img
                                                        src="assets/Eichelberger_black.jpg"
                                                        alt="Royal Heritage"
                                                        class="theme-preview mb-2"
                                                        id="preview-royal-heritage"
                                                    />
                                                    <div>
                                                        <strong
                                                            style="
                                                                color: var(
                                                                    --gold-primary
                                                                );
                                                            "
                                                            >Royal
                                                            Heritage</strong
                                                        ><br />
                                                        <small
                                                            style="
                                                                color: var(
                                                                    --text-gray
                                                                );
                                                            "
                                                            >Luxury black &
                                                            gold</small
                                                        >
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6 col-lg-3 mb-3">
                                            <div
                                                class="theme-selector"
                                                data-theme="rustic-roots"
                                                onclick="selectTheme('rustic-roots')"
                                            >
                                                <div class="text-center">
                                                    <img
                                                        src="assets/Eichelberger_rustic.jpg"
                                                        alt="Rustic Roots"
                                                        class="theme-preview mb-2"
                                                        id="preview-rustic-roots"
                                                    />
                                                    <div>
                                                        <strong
                                                            style="
                                                                color: var(
                                                                    --gold-primary
                                                                );
                                                            "
                                                            >Rustic
                                                            Roots</strong
                                                        ><br />
                                                        <small
                                                            style="
                                                                color: var(
                                                                    --text-gray
                                                                );
                                                            "
                                                            >Aged parchment
                                                            texture</small
                                                        >
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6 col-lg-3 mb-3">
                                            <div
                                                class="theme-selector"
                                                data-theme="vintage-botanical"
                                                onclick="selectTheme('vintage-botanical')"
                                            >
                                                <div class="text-center">
                                                    <img
                                                        src="assets/Eichelberger_green.jpg"
                                                        alt="Vintage Botanical"
                                                        class="theme-preview mb-2"
                                                        id="preview-vintage-botanical"
                                                    />
                                                    <div>
                                                        <strong
                                                            style="
                                                                color: var(
                                                                    --gold-primary
                                                                );
                                                            "
                                                            >Vintage
                                                            Botanical</strong
                                                        ><br />
                                                        <small
                                                            style="
                                                                color: var(
                                                                    --text-gray
                                                                );
                                                            "
                                                            >Cream & forest
                                                            green</small
                                                        >
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6 col-lg-3 mb-3">
                                            <div
                                                class="theme-selector"
                                                data-theme="ancestral-stone"
                                                onclick="selectTheme('ancestral-stone')"
                                            >
                                                <div class="text-center">
                                                    <img
                                                        src="assets/Eichelberger_stone.jpg"
                                                        alt="Ancestral Stone"
                                                        class="theme-preview mb-2"
                                                        id="preview-ancestral-stone"
                                                    />
                                                    <div>
                                                        <strong
                                                            style="
                                                                color: var(
                                                                    --gold-primary
                                                                );
                                                            "
                                                            >Ancestral
                                                            Stone</strong
                                                        ><br />
                                                        <small
                                                            style="
                                                                color: var(
                                                                    --text-gray
                                                                );
                                                            "
                                                            >Dark marble &
                                                            bronze</small
                                                        >
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <input
                                        type="hidden"
                                        id="selectedTheme"
                                        name="theme"
                                        value="royal-heritage"
                                    />
                                    <div class="form-text">
                                        Choose your preferred design theme for
                                        the family tree
                                    </div>
                                </div>

                                <!-- Total Price Display -->
                                <div id="totalPrice" class="mb-4">
                                    <!-- Price will be calculated and displayed here -->
                                </div>

                                <div class="text-center">
                                    <button
                                        type="submit"
                                        class="btn btn-nordic btn-lg"
                                    >
                                        <i class="fas fa-paper-plane me-2"></i>
                                        Submit Tree Request
                                    </button>
                                </div>
                            </form>

                            <!-- Note Box -->
                            <div
                                class="alert alert-info mt-4"
                                style="
                                    background: linear-gradient(
                                        135deg,
                                        #e0f2fe 0%,
                                        #e1f5fe 100%
                                    );
                                    border-color: var(--gold-primary);
                                    color: #0277bd;
                                "
                            >
                                <div class="d-flex align-items-start">
                                    <i
                                        class="fas fa-info-circle me-3 mt-1"
                                        style="color: var(--gold-primary)"
                                    ></i>
                                    <div>
                                        <strong
                                            style="color: var(--gold-primary)"
                                            >Note:</strong
                                        >
                                        Please ensure all names, dates, and
                                        pictures are up-to-date on
                                        familysearch.com before submitting a
                                        tree request. Our tree can only be as
                                        good as the data available in family
                                        search.
                                    </div>
                                </div>
                            </div>

                            <div
                                id="loadingIndicator"
                                class="text-center py-4 d-none"
                            >
                                <div
                                    class="spinner-border text-warning mb-3"
                                    role="status"
                                >
                                    <span class="visually-hidden"
                                        >Loading...</span
                                    >
                                </div>
                                <p style="color: var(--text-gray)">
                                    Submitting your family tree request...
                                    Please wait.
                                </p>
                            </div>

                            <div
                                id="errorMessage"
                                class="alert alert-danger d-none mt-4"
                            ></div>

                            <div
                                id="successMessage"
                                class="alert alert-success d-none mt-4"
                            >
                                <div class="text-center">
                                    <i
                                        class="fas fa-check-circle fa-2x mb-3"
                                        style="color: var(--gold-primary)"
                                    ></i>
                                    <h4>âœ… Request Submitted Successfully!</h4>
                                    <p class="mb-0">
                                        Thanks for submitting a family tree
                                        request. We will be in contact with you
                                        shortly with your completed family tree
                                        and to gather payment.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- How to Find Person IDs -->
                    <div class="card mt-4">
                        <div class="card-body p-4">
                            <h4 class="mb-3" style="color: var(--gold-primary)">
                                <i class="fas fa-question-circle me-2"></i>How
                                to Find Person IDs
                            </h4>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <div class="d-flex align-items-start">
                                        <div class="flex-shrink-0">
                                            <div
                                                class="rounded-circle d-flex align-items-center justify-content-center"
                                                style="
                                                    width: 40px;
                                                    height: 40px;
                                                    background-color: var(
                                                        --gold-primary
                                                    );
                                                    color: var(--deep-black);
                                                    font-weight: 600;
                                                "
                                            >
                                                1
                                            </div>
                                        </div>
                                        <div class="flex-grow-1 ms-3">
                                            <h6
                                                style="
                                                    color: var(--gold-primary);
                                                "
                                            >
                                                Go to FamilySearch.org
                                            </h6>
                                            <p
                                                class="mb-0"
                                                style="
                                                    color: var(--text-gray);
                                                    font-size: 0.9rem;
                                                "
                                            >
                                                Navigate to the person you want
                                                to use as the starting point
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="d-flex align-items-start">
                                        <div class="flex-shrink-0">
                                            <div
                                                class="rounded-circle d-flex align-items-center justify-content-center"
                                                style="
                                                    width: 40px;
                                                    height: 40px;
                                                    background-color: var(
                                                        --gold-primary
                                                    );
                                                    color: var(--deep-black);
                                                    font-weight: 600;
                                                "
                                            >
                                                2
                                            </div>
                                        </div>
                                        <div class="flex-grow-1 ms-3">
                                            <h6
                                                style="
                                                    color: var(--gold-primary);
                                                "
                                            >
                                                Look at the URL
                                            </h6>
                                            <p
                                                class="mb-0"
                                                style="
                                                    color: var(--text-gray);
                                                    font-size: 0.9rem;
                                                "
                                            >
                                                The Person ID is at the end of
                                                the URL (e.g.,
                                                /tree/person/details/KWQS-BYD)
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="d-flex align-items-start">
                                        <div class="flex-shrink-0">
                                            <div
                                                class="rounded-circle d-flex align-items-center justify-content-center"
                                                style="
                                                    width: 40px;
                                                    height: 40px;
                                                    background-color: var(
                                                        --gold-primary
                                                    );
                                                    color: var(--deep-black);
                                                    font-weight: 600;
                                                "
                                            >
                                                3
                                            </div>
                                        </div>
                                        <div class="flex-grow-1 ms-3">
                                            <h6
                                                style="
                                                    color: var(--gold-primary);
                                                "
                                            >
                                                Copy the ID
                                            </h6>
                                            <p
                                                class="mb-0"
                                                style="
                                                    color: var(--text-gray);
                                                    font-size: 0.9rem;
                                                "
                                            >
                                                Copy just the ID part (e.g.,
                                                KWQS-BYD) and paste it above
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer
            class="py-4 text-center"
            style="background-color: var(--deep-black); color: var(--text-gray)"
        >
            <div class="container">
                <div
                    class="d-flex align-items-center justify-content-center mb-2"
                >
                    <img
                        src="assets/saga.png"
                        alt="Family Saga"
                        style="
                            height: 25px;
                            width: auto;
                            margin-right: 8px;
                            border-radius: 50%;
                        "
                    />
                    <span style="color: var(--gold-primary); font-weight: 600"
                        >Family Saga</span
                    >
                </div>
                <p class="mb-0" style="font-size: 0.9rem">
                    Crafting luxury family stories with sophisticated elegance.
                </p>
            </div>
        </footer>

        <!-- Bootstrap JS -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

        <!-- Custom JS -->
        <script src="price-calculator.js"></script>
        <script src="familysearch.js"></script>
        <script>
            // Check if user is authenticated when page loads
            document.addEventListener("DOMContentLoaded", async function () {
                const accessToken = getCookie("fs_access_token");
                if (!accessToken) {
                    // No token found, redirect to login
                    window.location.href = "familysearch.html";
                    return;
                }

                // Set the global access token for the form submission
                window.accessToken = accessToken;

                // Fetch and display current person information
                await loadCurrentPersonInfo(accessToken);

                // Handle tree type changes to update generations options
                const treeTypeSelect = document.getElementById("treeType");
                if (treeTypeSelect) {
                    treeTypeSelect.addEventListener("change", function (e) {
                        const generationsSelect =
                            document.getElementById("generations");
                        const treeType = e.target.value;

                        if (treeType === "descendant") {
                            // For descendant trees, limit to 3-4 generations with 4 as default
                            generationsSelect.innerHTML = `
                                <option value="4" selected>4 Generations</option>
                                <option value="3">3 Generations</option>
                            `;
                        } else {
                            // For ancestor trees, show 4 or 5 with 5 as default
                            generationsSelect.innerHTML = `
                                <option value="5" selected>5 Generations</option>
                                <option value="4">4 Generations</option>
                            `;
                        }

                        // Update price display after changing generations
                        if (typeof updatePriceDisplay === "function") {
                            setTimeout(updatePriceDisplay, 50);
                        }
                    });
                }
            });

            async function loadCurrentPersonInfo(accessToken) {
                const currentPersonInfoDiv =
                    document.getElementById("currentPersonInfo");
                const startingPersonInput =
                    document.getElementById("startingPerson");
                const familyNameInput = document.getElementById("familyName");

                try {
                    // Show loading state
                    currentPersonInfoDiv.innerHTML =
                        '<p style="color: #6b7280; font-size: 0.9rem;">Loading your account information...</p>';

                    // Fetch current person data
                    const currentPerson =
                        await window.fetchCurrentPerson(accessToken);
                    const nameParts = currentPerson.name.split(" ");

                    if (
                        currentPerson &&
                        currentPerson.name !== "Unknown" &&
                        currentPerson.id !== "Unknown"
                    ) {
                        // Display current person info with Switch User button
                        currentPersonInfoDiv.innerHTML = `
                        <p style="margin: 8px 0; color: #047857; font-weight: 500;">
                            Logged in as <strong>${currentPerson.name}</strong><br>
                            <span style="font-size: 0.9rem; color: #059669;">FamilySearch ID: ${currentPerson.id}</span>
                        </p>
                        <button onclick="switchUser()" class="btn btn-outline-secondary btn-sm mt-2" style="border-color: var(--gold-primary); color: var(--gold-primary);">
                            <i class="fas fa-user-switch me-1"></i>Switch User
                        </button>
                    `;

                        // Auto-fill the Starting Person ID field
                        if (startingPersonInput) {
                            startingPersonInput.value = currentPerson.id;
                            startingPersonInput.style.backgroundColor =
                                "#ecfdf5";
                            startingPersonInput.style.borderColor = "#10b981";
                            startingPersonInput.style.color = "#047857";
                        }

                        // Auto-fill the Family Name field with last name
                        if (familyNameInput && nameParts.length > 0) {
                            familyNameInput.value =
                                nameParts[nameParts.length - 1]; // Last name
                            familyNameInput.style.backgroundColor = "#ecfdf5";
                            familyNameInput.style.borderColor = "#10b981";
                            familyNameInput.style.color = "#047857";
                        }

                        // Auto-fill the contact name field with full name
                        const contactNameInput =
                            document.getElementById("contactName");
                        if (contactNameInput) {
                            contactNameInput.value = currentPerson.name;
                            contactNameInput.style.backgroundColor = "#ecfdf5";
                            contactNameInput.style.borderColor = "#10b981";
                            contactNameInput.style.color = "#047857";
                        }
                    } else {
                        // Show fallback message if we couldn't get the person info
                        currentPersonInfoDiv.innerHTML = `
                        <p style="color: #6b7280; font-size: 0.9rem;">
                            Successfully authenticated with FamilySearch
                        </p>
                    `;
                    }
                } catch (error) {
                    console.error("Error loading current person info:", error);
                    // Show fallback message on error
                    currentPersonInfoDiv.innerHTML = `
                    <p style="color: #6b7280; font-size: 0.9rem;">
                        Successfully authenticated with FamilySearch
                    </p>
                `;
                }
            }

            // Theme selection functionality
            function selectTheme(themeName) {
                // Remove selected class from all theme selectors
                document
                    .querySelectorAll(".theme-selector")
                    .forEach((selector) => {
                        selector.classList.remove("selected");
                    });

                // Remove selected class from all theme previews
                document
                    .querySelectorAll(".theme-preview")
                    .forEach((preview) => {
                        preview.classList.remove("selected");
                    });

                // Add selected class to clicked theme
                const selectedSelector = document.querySelector(
                    `[data-theme="${themeName}"]`,
                );
                const selectedPreview = document.getElementById(
                    `preview-${themeName}`,
                );

                if (selectedSelector) {
                    selectedSelector.classList.add("selected");
                }
                if (selectedPreview) {
                    selectedPreview.classList.add("selected");
                }

                // Update hidden input value
                document.getElementById("selectedTheme").value = themeName;
            }

            // Initialize default theme selection
            document.addEventListener("DOMContentLoaded", function () {
                selectTheme("royal-heritage");
            });

            // Switch User functionality
            function switchUser() {
                // Clear all FamilySearch authentication data
                document.cookie =
                    "fs_access_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
                document.cookie =
                    "fs_refresh_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
                document.cookie =
                    "oauth_state=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";

                // Clear localStorage and sessionStorage
                localStorage.clear();
                sessionStorage.clear();

                // Clear global access token
                window.accessToken = null;

                // Add a timestamp parameter to force fresh authentication
                const timestamp = new Date().getTime();
                window.location.href = `familysearch.html?switch_user=true&t=${timestamp}`;
            }
        </script>
    </body>
</html>
