<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Tree Generator - Choose Your Source</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üå≥</text></svg>">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>üå≥ Family Tree Generator</h1>
            <p>Create beautiful family trees from your genealogy data</p>
        </header>

        <main>
            <div class="source-selection">
                <h2>Choose Your Data Source</h2>
                <p class="selection-description">Select how you'd like to provide your family tree data:</p>
                
                <div class="source-options">
                    <div class="source-option" onclick="selectSource('familysearch')">
                        <div class="option-icon">üë§</div>
                        <h3>FamilySearch Login</h3>
                        <p>Connect with your FamilySearch account to access your family tree data directly</p>
                        <div class="option-features">
                            <span class="feature">‚úì Direct access to your tree</span>
                            <span class="feature">‚úì Always up-to-date data</span>
                            <span class="feature">‚úì No file uploads needed</span>
                        </div>
                        <button class="source-btn familysearch-btn">
                            <span>Login with FamilySearch</span>
                            <span class="btn-arrow">‚Üí</span>
                        </button>
                    </div>

                    <div class="source-option" onclick="selectSource('gedcom')">
                        <div class="option-icon">üìÅ</div>
                        <h3>Ancestry GEDCOM File Upload</h3>
                        <p>Upload a GEDCOM file exported from Ancestry.</p>
                        <div class="option-features">
                            <span class="feature">‚úì Works with your GEDCOM file</span>
                            <span class="feature">‚úì Complete offline processing</span>
                            <span class="feature">‚úì No account required</span>
                        </div>
                        <button class="source-btn gedcom-btn">
                            <span>Upload GEDCOM File</span>
                            <span class="btn-arrow">‚Üí</span>
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <footer>
            <p>Generated by Remember Me ¬© Bryant McArthur and Tom Eichelberger</p>
        </footer>
    </div>

    <script src="familysearch.js"></script>
    <script>
        function selectSource(source) {
            if (source === 'familysearch') {
                window.location.href = 'familysearch.html';
            } else if (source === 'gedcom') {
                window.location.href = 'gedcom.html';
            }
        }

        // Add click handlers for the buttons as well
        document.addEventListener('DOMContentLoaded', function() {
            // Check if we're returning from OAuth callback first
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            setCookie('oauth_code', code, 24);
            const error = urlParams.get('error');

            if (error) {
                alert('Authentication failed: ' + error);
                return;
            }

            if (code) {
                // We're returning from OAuth, exchange code for token and redirect
                exchangeCodeForTokenAndRedirect(code);
                return;
            }

            // Normal page load - set up button handlers
            const familysearchBtn = document.querySelector('.familysearch-btn');
            const gedcomBtn = document.querySelector('.gedcom-btn');

            if (familysearchBtn) {
                familysearchBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    selectSource('familysearch');
                });
            }

            if (gedcomBtn) {
                gedcomBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    selectSource('gedcom');
                });
            }
        });

        async function exchangeCodeForTokenAndRedirect(code) {
            const storedState = getCookie('oauth_state');
            const returnedState = new URLSearchParams(window.location.search).get('state');
            
            if (storedState !== returnedState) {
                alert('Invalid state parameter. Authentication failed.');
                return;
            }

            // Show loading message
            document.querySelector('main').innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="width: 50px; height: 50px; border: 4px solid #f3f4f6; border-top: 4px solid #10b981; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                    <p style="color: #6b7280; font-size: 1.1rem;">Completing authentication...</p>
                    <style>
                        @keyframes spin {
                            0% { transform: rotate(0deg); }
                            100% { transform: rotate(360deg); }
                        }
                    </style>
                </div>
            `;

            try {
                // Exchange authorization code for access token
                const tokenData = {
                    grant_type: 'authorization_code',
                    code: code,
                    redirect_uri: window.location.origin + "/",
                    client_id: 'b00KBZ8PWGLG7SJ0A3U1'
                };
                console.log('Exchanging code for token:', tokenData);

                // const response = await fetch('https://identbeta.familysearch.org/cis-web/oauth2/v3/token', {
                const response = await fetch('https://ident.familysearch.org/cis-web/oauth2/v3/token', {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams(tokenData)
                });

                if (!response.ok) {
                    const errorData = await response.text();
                    console.error('Token exchange failed:', errorData);
                    throw new Error(`Token exchange failed: ${response.status}`);
                }

                const tokenResponse = await response.json();
                const accessToken = tokenResponse.access_token;

                if (accessToken) {
                    // Store token in cookie (expires in 24 hours)
                    setCookie('fs_access_token', accessToken, 24);
                    
                    // Clean up OAuth state
                    // deleteCookie('oauth_state');
                    
                    // Clean up URL and redirect to config page
                    window.history.replaceState({}, document.title, window.location.pathname);
                    window.location.href = 'familysearch-config.html';
                } else {
                    throw new Error('No access token received');
                }
                
            } catch (error) {
                console.error('Token exchange failed:', error);
                alert('Failed to complete authentication. Please try again.');
                // Reload the page to show the normal interface
                window.location.href = window.location.pathname;
            }
        }
    </script>
</body>
</html>
